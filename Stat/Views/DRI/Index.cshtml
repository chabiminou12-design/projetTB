@model Stat.Models.DRIDashboardViewModel
@using Stat.Services
@inject UserInfoService UserInfoSvc

@{
    ViewData["Title"] = "Tableau de Bord DRI";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var layoutData = await UserInfoSvc.GetLayoutUserDataAsync();
    var structureName = layoutData?.StructureName ?? " ";
    var today = DateTime.Now;
}
@if (ViewBag.ShowRapportUpload == true)
{
    <div class="card mb-4 border-left-warning shadow">
        <div class="card-body">
            <div class="row no-gutters align-items-center">
                <div class="col mr-2">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Rapport Obligatoire</div>
                    <div class="h5 mb-0 font-weight-bold text-gray-800">
                        Veuillez soumettre votre rapport @(today.Month == 7 || today.Month == 8 ? "Trimestriel" : "Annuel")
                    </div>
                </div>
                <div class="col-auto">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#uploadRapportModal">
                        <i class="fas fa-upload fa-2x text-gray-300"></i> Télécharger
                    </button>
                </div>
            </div>
        </div>
        @if (TempData["ErrorMessage"] != null)
        {
            <div class="alert alert-danger alert-dismissible fade show text-center" role="alert">
                @TempData["ErrorMessage"]

                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        }
    </div>
}

<div class="modal fade" id="uploadRapportModal" tabindex="-1">
    <div class="modal-dialog">
        <form asp-action="UploadRapport" method="post" enctype="multipart/form-data">
            <input type="hidden" name="type" value="@(today.Month == 7 || today.Month == 8 ? "Trimestriel" : "Annuel")" />
            <input type="hidden" name="year" value="@(today.Month == 1 || today.Month == 2 ? today.Year - 1 : today.Year)" />
            <div class="modal-content">
                <div class="modal-header"><h5>Télécharger le Rapport</h5></div>
                <div class="modal-body">
                    <input type="file" name="rapportFile" class="form-control" accept=".pdf,.doc,.docx" required />
                    <small class="text-muted">Formats acceptés: PDF, DOC, DOCX</small>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-success">Envoyer</button>
                </div>
            </div>
        </form>
    </div>
</div>
@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
        @TempData["SuccessMessage"]

        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div class="container-fluid px-4">
    <div class="d-flex justify-content-between align-items-center mt-4">
        <div>
            <h1>Espace Direction Régionale @structureName</h1>
            <p class="text-muted">Vue d'ensemble et Performance Consolidée</p>
        </div>
    </div>

    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">@ViewData["Title"]</li>
    </ol>

    <h3 class="h5 text-primary"><i class="fas fa-chart-line me-2"></i>Performance Propre (Situation DRI)</h3>
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DRI_TotalSituations</div>
                    <div class="fs-15">Situations DRI (Total)</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DRI_SituationsInProgress</div>
                    <div class="fs-15">DRI: En Cours / Rejetées</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-info text-white mb-4">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DRI_SituationsPending</div>
                    <div class="fs-15">DRI: En Attente Validation</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DRI_SituationsValidated</div>
                    <div class="fs-15">DRI: Situations Validées</div>
                </div>
            </div>
        </div>
    </div>

    <h3 class="h5 text-secondary mt-2"><i class="fas fa-sitemap me-2"></i>Performance Consolidée (DIWs Gérés)</h3>
    <div class="row">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card text-white mb-4" style="background-color: #5d6d7e;">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DIW_TotalSituations</div>
                    <div class="fs-15">Situations DIW (Total)</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-warning text-white mb-4">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DIW_SituationsInProgress</div>
                    <div class="fs-15">DIW: En Cours / Rejetées</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-info text-white mb-4">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DIW_SituationsPending</div>
                    <div class="fs-15">DIW: En Attente Validation</div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card bg-success text-white mb-4">
                <div class="card-body">
                    <div class="fs-6 fw-bold">@ViewBag.DIW_SituationsValidated</div>
                    <div class="fs-15">DIW: Situations Validées</div>
                </div>
            </div>
        </div>
    </div>

    <hr />

    <div class="row">
        <div class="col-8">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-balance-scale-right me-1"></i>
                    Performance par DIW de l'Année @DateTime.Now.Year
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>DIW</th>
                                    <th class="text-center">Situations Total</th>
                                    <th class="text-center">Performance (%)</th>
                                    <th class="text-center">Situations Valide</th>
                                    <th class="text-center">Situations en Attente</th>
                                    <th class="text-center">Situations En Cours / Rejetées</th>
                                    <th class="text-center">Situations Manquantes</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var diw in Model.DiwComparisonData)
                                {
                                    <tr>
                                        <td><strong>@diw.DiwName</strong></td>
                                        <td class="text-center fs-5">
                                            <span class="badge rounded-pill bg-secondary text-white">@diw.TotalSituationsCount</span>
                                        </td>
                                        <td>
                                            <div class="progress">
                                                <div class="progress-bar @(diw.OverallPerformance >= 80 ? "bg-success" : diw.OverallPerformance >= 50 ? "bg-warning" : "bg-danger")" role="progressbar" style="width: @diw.OverallPerformance.ToString("F0")%;" aria-valuenow="@diw.OverallPerformance" aria-valuemin="0" aria-valuemax="100">
                                                    @diw.OverallPerformance.ToString("F2")%
                                                </div>
                                            </div>
                                        </td>
                                        <td class="text-center fs-5">
                                            <span class="badge rounded-pill bg-success text-white">@diw.ValideSituationsCount</span>
                                        </td>
                                        <td class="text-center fs-5">
                                            <span class="badge rounded-pill bg-info text-dark">@diw.PendingSituationsCount</span>
                                        </td>

                                        <td class="text-center fs-5">
                                            <span class="badge rounded-pill bg-warning text-dark">@diw.RejectedSituationsCount</span>
                                        </td>
                                        <td class="text-center fs-5">
                                            <span class="badge rounded-pill bg-danger">@diw.ManqueSituationsCount</span>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-4">
            <div class="card mb-4 h-100">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    Répartition des Statuts (Toutes Périodes)
                </div>
                <div class="card-body"><canvas id="statusPieChart" width="100%" height="100%"></canvas></div>
            </div>
        </div>
    </div>

    @foreach (var yearSummary in Model.YearlySummaries)
    {
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h3 class="h5 mb-0">Performance de l'Année @yearSummary.Year</h3>
                <small class="text-muted">Incluant Performance Propre et Consolidée</small>
            </div>
            <div class="card-body">
                <div class="row">
                    @if (yearSummary.Charts.Any())
                    {
                        @foreach (var chart in yearSummary.Charts)
                        {
                            <div class="col-xl-6 mb-4">
                                <div class="card h-100">
                                    <div class="card-header">
                                        <i class="fas fa-chart-bar me-1"></i>
                                        @chart.CategoryName
                                    </div>
                                    <div class="card-body">
                                        <select class="form-select form-select-sm mb-2 chart-indicator-filter" data-chart-id="@chart.ChartId">
                                            <option value="all">-- Tous les indicateurs --</option>
                                            @foreach (var label in chart.Labels)
                                            {
                                                <option value="@label">@label</option>
                                            }
                                        </select>
                                        <canvas id="@chart.ChartId"></canvas>
                                    </div>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <p class="text-center text-muted">Aucune donnée de performance confirmée pour cette année.</p>
                    }
                </div>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.js" crossorigin="anonymous"></script>
    <script type="text/javascript">
        document.addEventListener("DOMContentLoaded", function () {

            // --- 1. INITIALISATION BAR CHART (Progression) ---
            var ctxBar = document.getElementById("diwPerformanceChart");
            if (ctxBar) {
                new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: @Html.Raw(Json.Serialize(Model.DiwPerformanceChart.Labels)),
                        datasets: [
                            { label: 'Situations Soumises', backgroundColor: 'rgba(54, 162, 235, 0.8)', data: @Html.Raw(Json.Serialize(Model.DiwPerformanceChart.SituationsAtteintData)) },
                            { label: 'Situations Manquantes', backgroundColor: 'rgba(255, 159, 64, 0.8)', data: @Html.Raw(Json.Serialize(Model.DiwPerformanceChart.EcartNegatifData)) }
                        ],
                    },
                    options: {
                        tooltips: { mode: 'index', intersect: false },
                        scales: { xAxes: [{ stacked: true }], yAxes: [{ stacked: true, ticks: { beginAtZero: true, precision: 0 } }], },
                        legend: { display: true }
                    }
                });
            }

            // --- 2. INITIALISATION PIE CHART (Statuts) ---
            var ctxPie = document.getElementById("statusPieChart");
            if (ctxPie) {
                new Chart(ctxPie, {
                    type: 'doughnut',
                    data: {
                        labels: @Html.Raw(Json.Serialize(Model.StatusPieChart.Labels)),
                        datasets: [{ data: @Html.Raw(Json.Serialize(Model.StatusPieChart.Data)), backgroundColor: ['#ffc107', '#28a745', '#dc3545', '#6c757d'], }],
                    },
                });
            }

            // --- 3. INITIALISATION DES GRAPHIQUES DYNAMIQUES (Performance Propre + Consolidée) ---
            window.myCharts = window.myCharts || {};
            window.originalChartData = window.originalChartData || {};

            function updateChart(chartId, selectedIndicator) {
                const chart = window.myCharts[chartId];
                const originalData = window.originalChartData[chartId];
                if (!chart || !originalData) return;

                if (selectedIndicator === 'all') {
                    chart.data.labels = originalData.labels;
                    chart.data.datasets.forEach((dataset, i) => { dataset.data = originalData.datasets[i].data; });
                } else {
                    const index = originalData.labels.indexOf(selectedIndicator);
                    if (index > -1) {
                        chart.data.labels = [originalData.labels[index]];
                        chart.data.datasets.forEach((dataset, i) => { dataset.data = [originalData.datasets[i].data[index]]; });
                    }
                }
                chart.update();
            }

            // Génération JavaScript dynamique via boucle Razor
        @foreach (var yearSummary in Model.YearlySummaries)
        {
            @foreach (var chart in yearSummary.Charts)
            {
                <text>
                                    // Création ID unique pour JS
                                    const chartId_@chart.ChartId.Replace("-", "") = "@chart.ChartId";
                    const ctx_@chart.ChartId.Replace("-", "") = document.getElementById(chartId_@chart.ChartId.Replace("-", ""));

                    if (ctx_@chart.ChartId.Replace("-", "")) {
                    // Sauvegarde données originales pour le filtre
                    window.originalChartData[chartId_@chart.ChartId.Replace("-", "")] = {
                        labels: @Html.Raw(Json.Serialize(chart.Labels)),
                            datasets: [
                                { label: 'Performance Atteinte', data: @Html.Raw(Json.Serialize(chart.PerformanceJusquaCible)) },
                                { label: 'Écart Négatif (Manquant)', data: @Html.Raw(Json.Serialize(chart.EcartNegatif)) },
                                { label: 'Dépassement de la Cible', data: @Html.Raw(Json.Serialize(chart.DepassementCible)) }
                            ]
                    };

                    // Création du Chart HorizontalBar
                    window.myCharts[chartId_@chart.ChartId.Replace("-", "")] = new Chart(ctx_@chart.ChartId.Replace("-", ""), {
                        type: 'horizontalBar',
                        data: {
                            labels: @Html.Raw(Json.Serialize(chart.Labels)),
                            tauxAtteints: @Html.Raw(Json.Serialize(chart.TauxAtteintData)),
                            cibles: @Html.Raw(Json.Serialize(chart.CibleData)),
                            datasets: [
                                { label: 'Performance Atteinte', backgroundColor: 'rgba(54, 162, 235, 0.8)', data: @Html.Raw(Json.Serialize(chart.PerformanceJusquaCible)) },
                                { label: 'Écart Négatif (Manquant)', backgroundColor: 'rgba(255, 159, 64, 0.8)', data: @Html.Raw(Json.Serialize(chart.EcartNegatif)) },
                                { label: 'Dépassement de la Cible', backgroundColor: 'rgba(75, 192, 192, 0.8)', data: @Html.Raw(Json.Serialize(chart.DepassementCible)) }
                            ]
                        },
                        options: {
                            responsive: true,
                            tooltips: {
                                callbacks: {
                                    footer: function (tooltipItems, data) {
                                        const originalLabels = window.originalChartData[chartId_@chart.ChartId.Replace("-", "")].labels;
                                    const currentLabel = data.labels[tooltipItems[0].index];
                                    const originalIndex = originalLabels.indexOf(currentLabel);
                                    let taux = data.tauxAtteints[originalIndex];
                                    let cible = data.cibles[originalIndex];
                                    let ecart = taux - cible;
                                    return [`Taux Atteint: ${taux.toFixed(2)}%`, `Cible: ${cible.toFixed(2)}%`, `Écart: ${ecart.toFixed(2)}%`];
                                }
                            }
                        },
                        scales: {
                            xAxes: [{ stacked: true, ticks: { callback: function (v) { return v + "%" } } }],
                            yAxes: [{ stacked: true }]
                        }
                    }
                                        });
                                    }
                </text>
            }
        }

            // Attachement des événements de filtrage
            document.querySelectorAll('.chart-indicator-filter').forEach(select => {
                select.addEventListener('change', function () {
                    const chartId = this.dataset.chartId;
                    const selectedIndicator = this.value;
                    updateChart(chartId, selectedIndicator);
                });
            });
                });
    </script>
}