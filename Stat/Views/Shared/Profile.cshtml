@model Stat.Models.ViewModels.ProfileViewModel
@using Stat.Models.Enums
@using Microsoft.AspNetCore.Authorization
@using Stat.Helpers
@using Stat.Services
@inject IAuthorizationService AuthorizationService
@inject UserInfoService UserInfoService
@{
    ViewData["Title"] = "Mon Profil";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var layoutData = await UserInfoService.GetLayoutUserDataAsync();
    var currentUser = layoutData?.CurrentUser;
}
     <style>
        .profile-avatar-xl {
            /* Size and Shape */
            width: 120px;
            height: 120px;
            border-radius: 50%;

            /* General Appearance */
            object-fit: cover; /* Ensures image fills the circle */
            border: 4px solid #ffffff; /* Clean white border */
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15); /* Subtle shadow */

            /* Initials Specific Styling (for the <div>
            ) */
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 2.5rem; /* Large font for initials */
            color: #ffffff; /* White text for initials */
            font-weight: 600;
            text-transform: uppercase;
            /* This ensures it centers properly */
            margin-left: auto;
            margin-right: auto;
            }
    </style>
<div class="container-fluid px-4">
    <h1 class="mt-4">@ViewData["Title"]</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a asp-action="Index">Tableau de bord</a></li>
        <li class="breadcrumb-item active">Profil</li>
    </ol>
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div class="row">
        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-body text-center">
                    @if (!string.IsNullOrEmpty(currentUser.ProfilePictureUrl))
                    {
                        <img src="@currentUser.ProfilePictureUrl" class="profile-avatar-xl mb-3">
                    }
                    else
                    {
                        <div class="profile-avatar-xl mb-3" style="background-color: @AvatarHelper.GetBackgroundColor(currentUser.FirstNmUser)">
                            @AvatarHelper.GetInitials(currentUser.FirstNmUser)
                        </div>
                    }
                    <h5 class="my-3">@Model.UserProfile.FirstNmUser @Model.UserProfile.LastNmUser</h5>
                    <p class="text-muted mb-1">@Model.RoleName</p>
                    @if (!string.IsNullOrEmpty(Model.ParentStructureName))
                    {
                        <p class="text-muted mb-1">DIW  @Model.StructureName</p>
                        <p class="text-muted mb-4">DRI  @Model.ParentStructureName</p>
                    }
                    else
                    {
                        <p class="text-muted mb-4">@Model.StructureName</p>
                    }
                    <div class="d-grid gap-2">
                        <a asp-controller="Access" asp-action="ChangePassword" class="btn btn-outline-primary">Changer le mot de passe</a>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">Détails du Compte</div>
                <div class="card-body">
                    <div id="contact-display">
                        <div class="row mb-3">
                            <div class="col-sm-4">Nom d'utilisateur</div>
                            <div class="col-sm-8 text-muted" id="displayUsername">@Model.UserProfile.User_name</div>
                        </div>
                        <hr />
                        @if (!string.IsNullOrEmpty(Model.ParentStructureName))
                        {
                            <div class="row mb-3">
                                <div class="col-sm-4">Structure (DIW)</div>
                                <div class="col-sm-8 text-muted">@Model.StructureName</div>
                            </div>
                            <hr />
                            <div class="row mb-3">
                                <div class="col-sm-4">Structure Parente (DRI)</div>
                                <div class="col-sm-8 text-muted">@Model.ParentStructureName</div>
                            </div>
                            <hr />
                        }
                        <div class="row mb-3">
                            <div class="col-sm-4">Email</div>
                            <div class="col-sm-8 text-muted" id="displayEmail">@Model.UserProfile.MailUser</div>
                        </div>
                        <hr />
                        <div class="row mb-3">
                            <div class="col-sm-4">Téléphone</div>
                            <div class="col-sm-8 text-muted" id="displayPhone">@Model.UserProfile.TelUser</div>
                        </div>
                        <hr />
                        <div class="row">
                            <div class="col-sm-4">Dernière Connexion</div>
                            <div class="col-sm-8 text-muted">@Model.UserProfile.LastCnx?.ToString("g")</div>
                        </div>
                        <button class="btn btn-primary mt-3" id="editContactBtn">Modifier les Informations</button>
                    </div>

                    <form id="contact-form" class="d-none">
                        @Html.AntiForgeryToken()
                        <div class="mb-3 row">
                            <label class="col-sm-4 col-form-label">Nom d'utilisateur</label>
                            <div class="col-sm-8">
                                <input type="text" class="form-control-plaintext" id="inputUsername" value="@Model.UserProfile.User_name" readonly />
                            </div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-4 col-form-label">Email</label>
                            <div class="col-sm-8"><input type="email" class="form-control" id="inputEmail" value="@Model.UserProfile.MailUser" required /></div>
                        </div>
                        <div class="mb-3 row">
                            <label class="col-sm-4 col-form-label">Téléphone</label>
                            <div class="col-sm-8"><input type="text" class="form-control" id="inputPhone" value="@Model.UserProfile.TelUser" required /></div>
                        </div>
                        <button type="submit" class="btn btn-success">Sauvegarder</button>
                        <button type="button" class="btn btn-secondary" id="cancelContactBtn">Annuler</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const token = document.querySelector('input[name="__RequestVerificationToken"]').value;
            const displayDiv = document.getElementById('contact-display');
            const formDiv = document.getElementById('contact-form');
            const editBtn = document.getElementById('editContactBtn');
            const cancelBtn = document.getElementById('cancelContactBtn');

            editBtn.addEventListener('click', () => {
                displayDiv.classList.add('d-none');
                formDiv.classList.remove('d-none');
            });

            cancelBtn.addEventListener('click', () => {
                displayDiv.classList.remove('d-none');
                formDiv.classList.add('d-none');
            });

            formDiv.addEventListener('submit', function (e) {
                e.preventDefault();
                const email = document.getElementById('inputEmail').value;
                const phone = document.getElementById('inputPhone').value;

                // ✨ The username is no longer sent for update
                fetch('@Url.Action("UpdateProfileInfo")', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded', 'RequestVerificationToken': token },
                    body: `email=${encodeURIComponent(email)}&phone=${encodeURIComponent(phone)}`
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            document.getElementById('displayEmail').textContent = email;
                            document.getElementById('displayPhone').textContent = phone;
                            cancelBtn.click();
                            alert(data.message);
                        } else {
                            alert(`Erreur: ${data.message}`);
                        }
                    });
            });
        });
    </script>
}