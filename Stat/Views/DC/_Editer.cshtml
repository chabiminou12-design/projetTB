@model Stat.Models.IndexViewModel
@{
    ViewData["Title"] = "Gestion des Situations Stratégiques";
    Layout = "~/Views/Shared/_Layout.cshtml"; 
    var diwUsers = ViewBag.DiwUsers as Dictionary<string, string> ?? new Dictionary<string, string>();
    var currentUserId = (string)ViewBag.CurrentUserId;
    // --- NOUVELLE LOGIQUE DE DATE ---
    var currentYear = DateTime.Now.Year;
    var currentMonth = DateTime.Now.Month; // Numéro du mois
    var currentCulture = new System.Globalization.CultureInfo("fr-FR");

    // Crée une liste d'années de 2025 (ou l'année en cours si < 2025) jusqu'à l'année en cours.
    var baseYear = 2025;
    if (baseYear > currentYear) { baseYear = currentYear; } 

    var yearList = Enumerable.Range(baseYear, currentYear - baseYear + 1)
                            .Select(y => new SelectListItem {
                                Text = y.ToString(),
                                Value = y.ToString()
                            })
                            .OrderByDescending(y => y.Value) // Affiche l'année en cours en premier
                            .ToList();
    
    var years = new SelectList(yearList, "Value", "Text", currentYear);

    // --- Logique pour les Mois (pour le chargement initial) ---
    var initialMonths = Enumerable.Range(1, currentMonth) // Va de 1 au mois actuel
        .Select(m => {
            var monthName = currentCulture.DateTimeFormat.GetMonthName(m);
            monthName = char.ToUpper(monthName[0]) + monthName.Substring(1); 
            return new SelectListItem {
                Text = monthName,
                Value = monthName 
            };
        }).ToList();

    var months = new SelectList(initialMonths, "Value", "Text");

    // --- Préparation pour JavaScript ---
    var allMonthsJson = System.Text.Json.JsonSerializer.Serialize(
        Enumerable.Range(1, 12).Select(m => {
            var monthName = currentCulture.DateTimeFormat.GetMonthName(m);
            return char.ToUpper(monthName[0]) + monthName.Substring(1);
        }).ToList()
    );
    // --- FIN DU BLOC DE DATE ---
}

<style>
    /* Makes the card for creating a new situation stick to the top */
    #creation-card {
        position: -webkit-sticky; 
        position: sticky; 
        top: 0;
        z-index: 1020; 
    }

    /* Makes the table header cells stick to the top */
    #datatablesSimple thead th {
        position: -webkit-sticky; 
        position: sticky; 
        top: 0; /* This will be adjusted by JavaScript */
        z-index: 1010; 
        background-color: #f8f9fa; 
    }

    .status-review {
        display: inline-block;
        padding: 6px 12px;
        font-size: 14px;
        font-weight: 900;
        color: #8a1f11; /* professional dark red */
        background-color: #fff4e5; /* soft warning yellow */
        border-left: 4px solid #d32f2f; /* interdiction indicator */
        border-radius: 4px;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
        letter-spacing: 0.2px;
    }

</style>

<div class="container-fluid px-4">
    <h1 class="mt-4">Gestion des Situations</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">@ViewData["Title"]</li>
    </ol>
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show text-center" role="alert">
            @TempData["SuccessMessage"]

            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }
    <div id="creation-card" class="card mb-4">
        <div class="card-header"><i class="fas fa-plus-circle me-1"></i> Créer une Nouvelle Situation</div>
       
        <div class="card-body">
            @if (TempData["Message"] != null)
            {
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    @TempData["Message"]
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            }
            
            <form asp-controller="DC" asp-action="_Editer" method="post">
   
                <div class="row gx-3 align-items-end"> 
                    @* MODIFIÉ : Remplacement des options codées en dur par asp-items, en gardant la structure sur une ligne *@
                    <div class="col-md-2"><label asp-for="Month" class="form-label">Mois</label><select class="form-select" asp-for="Month" asp-items="months" required><option value="">Sélectionnez un mois</option></select></div>
                    <div class="col-md-2"><label asp-for="Year" class="form-label">Année</label><select class="form-select" asp-for="Year" asp-items="years" required><option value="">Sélectionnez l'année</option></select></div>
                    
                    @* Structure originale du bouton conservée intacte *@
                    <div class="col-md-2"><div class="d-grid"><button type="submit" class="btn btn-primary">Ajouter Situation</button></div></div>
                </div> 
            </form>
        </div>
    </div>

    <div class="card mb-4">
        <div class="card-header"><i class="fas fa-table me-1"></i> Liste de vos Situations</div>
        <div class="card-body">
            <table id="datatablesSimple" class="table table-striped table-hover">
                <thead> 
                    <tr>
                        <th>Période</th>
                        <th>Date de Création</th>
                        <th>Créé par</th>
                        <th>Statut</th>
                        <th class="text-center">Actions</th> 
                    </tr>
                </thead>
                <tbody>
                    @foreach (var situation in Model.Situations)
                    { 
                        <tr>
                            <td>@situation.Month @situation.Year</td>
                            <td>@(situation.CreateDate?.ToString("dd/MM/yyyy HH:mm") ?? "N/A")</td>
                            <td>@(diwUsers.TryGetValue(situation.User_id, out var name) ? name : "Inconnu")</td>
                            <td>
                                @switch (situation.Statut)
                                {
                                    case 0: 
                                        <span class="badge bg-warning text-dark">En cours</span>
                                        ; 
                                        break;
                                    case 1: 
                                        <span class="badge bg-primary">Soumis pour validation</span>
                                        ;
                                        break; 
                                    case 2:
                                        <span class="badge bg-danger">Rejeté</span>
                                        ;
                                        break; 
                                    case 3:
                                        <span class="badge bg-success">Validé</span>
                                        ;
                                        break; 
                                }
                            </td>
                            <td class="text-center">
                                @if (situation.User_id == currentUserId)
                                {
                                    @if (situation.Statut == 0 || situation.Statut == 2)
                                    {
                                        <div class="d-flex justify-content-center">
                                            <a asp-controller="DC" asp-action="_Validite" asp-route-id="@situation.IDSituation" class="btn btn-primary btn-sm me-2">Modifier</a>
                                            @if (situation.Statut == 0)
                                            {
                                                <button type="button" class="btn btn-danger btn-sm" 
                                                data-bs-toggle="modal"
                                                data-bs-target="#confirmDeleteModal" 
                                                data-id="@situation.IDSituation"> 
                                                    Supprimer
                                                </button>
                                            } 
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="d-flex justify-content-center"> 
                                            <a asp-controller="DC" asp-action="Consulte" asp-route-id="@situation.IDSituation" class="btn btn-info btn-sm me-2">Consulter</a>
                                            @if (situation.Statut == 3)
                                            {
                                                <a asp-controller="DC" asp-action="ExportToExcel" asp-route-id="@situation.IDSituation" class="btn btn-success btn-sm me-2" title="Télécharger en Excel">
                                                    <i class="fas fa-file-excel"></i> Excel 
                                                </a>
                                                <a asp-controller="DC" asp-action="ExportToPdf" asp-route-id="@situation.IDSituation" class="btn btn-danger btn-sm" title="Télécharger en PDF"> 
                                                    <i class="fas fa-file-pdf"></i> PDF
                                                </a>
                                            }
                                            
                                        </div>
                                    }
                                }
                                else
                                {
                                    <div class="d-flex justify-content-center">
                                        @if (situation.Statut == 3)
                                        {
                                            <a asp-controller="DC" asp-action="Consulte" asp-route-id="@situation.IDSituation" class="btn btn-info btn-sm me-2">Consulter</a>
                                        
                                            <a asp-controller="DC" asp-action="ExportToExcel" asp-route-id="@situation.IDSituation" class="btn btn-success btn-sm me-2" title="Télécharger en Excel">
                                                <i class="fas fa-file-excel"></i> Excel
                                            </a>
                                            <a asp-controller="DC" asp-action="ExportToPdf" asp-route-id="@situation.IDSituation" class="btn btn-danger btn-sm" title="Télécharger en PDF">
                                                <i class="fas fa-file-pdf"></i> PDF
                                            </a>
                                        }
                                        else if(situation.Statut == 1)
                                        {
                                            <a asp-controller="DC" asp-action="Consulte" asp-route-id="@situation.IDSituation" class="btn btn-info btn-sm me-2">Consulter</a>


                                        }
                                        else if (situation.Statut == 0)
                                        {
                                            <span class="status-review">En cours de réalisation</span>
                                        }
                                        else if (situation.Statut == 2)
                                        {
                                            <span class="status-review">En cours de révision</span>
                                        }
                                    </div>
                                }
                            </td>
                        </tr>
                    } 
                </tbody>
            </table>
        </div>
    </div>
</div>
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmation de Suppression</h5> 
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr de vouloir supprimer cette situation ?
                <br /> 
                <strong>Cette action est irréversible.</strong>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                <form id="deleteForm" asp-controller="DC" asp-action="Delete" method="post">
                    <button type="submit" class="btn btn-danger">Confirmer la Suppression</button> 
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/simple-datatables@latest/dist/umd/simple-datatables.js" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const datatablesSimple = document.getElementById('datatablesSimple');
            
            if (datatablesSimple) { 
                new simpleDatatables.DataTable(datatablesSimple, {
                    perPage: 15,
                    perPageSelect: [10, 15, 25, 50, 100],
                    labels: {
                        placeholder: "Rechercher...", 
                        perPage: "{select} situations par page",
                        noRows: "Aucune situation trouvée",
                        info: "Affichage de {start} à {end} sur {rows} situations",
                    } 
                });
            } 

            var confirmDeleteModal = document.getElementById('confirmDeleteModal'); 
            if (confirmDeleteModal) { 
                confirmDeleteModal.addEventListener('show.bs.modal', function (event) {
                    var button = event.relatedTarget;
                    var situationId = button.getAttribute('data-id');
                    var deleteForm = confirmDeleteModal.querySelector('#deleteForm');
                    var actionUrl = `/DC/Delete/${situationId}`; 
                    deleteForm.setAttribute('action', actionUrl);
                });
            } 

            // ✨ NOUVEAU BLOC AJOUTÉ : Logique dynamique Mois/Année ✨
            
            // 1. Récupérer les données de C#
            const allMonths = @Html.Raw(allMonthsJson); // ["Janvier", "Février", ...]
            const cYear = @currentYear;
            const cMonthIndex = @currentMonth - 1; // Index JS (0 = Janvier)

            // 2. Cibler les listes déroulantes (IDs générés par asp-for)
            const yearSelect = document.getElementById('Year');
            const monthSelect = document.getElementById('Month');

            if (yearSelect && monthSelect) {
                
                // 3. Fonction pour mettre à jour la liste des mois
                function updateMonthOptions() {
                    const selectedYearVal = yearSelect.value;
                    const selectedYear = selectedYearVal ? parseInt(selectedYearVal) : 0;
                    const selectedMonthValue = monthSelect.value; 

                    // Vider la liste des mois
                    monthSelect.innerHTML = ''; 

                    // Ajoute l'option par défaut (requise par le formulaire)
                    const defaultOption = document.createElement('option');
                    defaultOption.value = "";
                    defaultOption.text = "Sélectionnez un mois";
                    monthSelect.appendChild(defaultOption);

                    let monthsToShow = [];

                    if (selectedYear === cYear) {
                        // Année en cours : Affiche les mois jusqu'au mois actuel
                        monthsToShow = allMonths.slice(0, cMonthIndex + 1);
                    } else if (selectedYear >= 2025) { // Année passée (mais valide)
                        // Année passée : Affiche tous les 12 mois
                        monthsToShow = allMonths;
                    }
                    // Si 0, la liste reste vide

                    // 4. Remplir avec les nouvelles options
                    monthsToShow.forEach(function(monthName) {
                        const option = document.createElement('option');
                        option.value = monthName;
                        option.text = monthName;
                        
                        // Resélectionne le mois s'il était déjà choisi
                        if (monthName === selectedMonthValue) {
                            option.selected = true; 
                        }
                        monthSelect.appendChild(option);
                    });
                }

                // 5. Attacher l'écouteur d'événement
                yearSelect.addEventListener('change', updateMonthOptions);
                // 6. Appeler au cas où la page est rechargée avec une année sélectionnée
                updateMonthOptions();
            }
            // ✨ FIN DU BLOC AJOUTÉ ✨

            // Script original pour ajuster le header sticky 
            function adjustTableHeaderPosition() {
                const creationCard = document.getElementById('creation-card'); 
                const tableHeaders = document.querySelectorAll('#datatablesSimple thead th'); 

                if (creationCard && tableHeaders.length > 0) {
                    const cardHeight = creationCard.offsetHeight;
                    tableHeaders.forEach(th => { 
                        th.style.top = cardHeight + 'px';
                    });
                } 
            }

            // Adjust on initial page load
            adjustTableHeaderPosition(); 
            // Adjust again if the window is resized
            window.addEventListener('resize', adjustTableHeaderPosition); 
        });
    </script>
}